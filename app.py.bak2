import streamlit as st
import google.generativeai as genai
import streamlit.components.v1 as components

# --- CONFIGURATION & SETUP ---
st.set_page_config(
    page_title="Landing Page Generator AI",
    page_icon="üöÄ",
    layout="wide"
)

import json

import requests
from bs4 import BeautifulSoup


import PyPDF2
import docx
import io

import base64

# --- HELPER FUNCTIONS ---
def image_to_base64(uploaded_file):
    try:
        bytes_data = uploaded_file.getvalue()
        base64_str = base64.b64encode(bytes_data).decode()
        mime_type = uploaded_file.type
        return f"data:{mime_type};base64,{base64_str}"
    except Exception as e:
        return None

def read_file_content(uploaded_file):
    try:
        if uploaded_file.type == "application/pdf":
            pdf_reader = PyPDF2.PdfReader(uploaded_file)
            text = ""
            for page in pdf_reader.pages:
                text += page.extract_text()
            return text
        elif uploaded_file.type == "application/vnd.openxmlformats-officedocument.wordprocessingml.document":
            doc = docx.Document(uploaded_file)
            text = "\n".join([paragraph.text for paragraph in doc.paragraphs])
            return text
        elif uploaded_file.type == "text/plain":
            return uploaded_file.getvalue().decode("utf-8")
        else:
            return "Format file tidak didukung."
    except Exception as e:
        return f"Gagal membaca file: {e}"


def scrape_content(url):
    try:
        headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'}
        response = requests.get(url, headers=headers, timeout=10)
        soup = BeautifulSoup(response.content, 'html.parser')
        
        # Remove script and style elements
        for script in soup(["script", "style"]):
            script.decompose()
            
        # Get text
        text = soup.get_text(separator=' ')
        
        # Break into lines and remove leading/trailing space on each
        lines = (line.strip() for line in text.splitlines())
        # Break multi-headlines into a line each
        chunks = (phrase.strip() for line in lines for phrase in line.split("  "))
        # Drop blank lines
        text = '\n'.join(chunk for chunk in chunks if chunk)
        
        return text[:5000] # Limit characters
    except Exception as e:
        return f"Gagal scraping: {e}"

import os

# --- SIDEBAR ---
with st.sidebar:
    st.header("Konfigurasi")
    
    # Try to load existing key
    current_keys_str = ""
    if "GOOGLE_API_KEY" in st.secrets:
        if st.secrets["GOOGLE_API_KEY"] != "PASTE_YOUR_API_KEY_HERE":
            current_keys_str = st.secrets["GOOGLE_API_KEY"]
            
    # Split existing keys for pre-filling
    current_keys_list = [k.strip() for k in current_keys_str.split('\n') if k.strip()]

    st.info("Masukkan hingga 10 API Key. Sistem akan otomatis ganti ke key berikutnya jika limit habis.")
    
    new_api_keys = []
    with st.expander("üîë Kelola API Keys (Max 10)", expanded=False):
        for i in range(10):
            # Get existing value if available
            val = current_keys_list[i] if i < len(current_keys_list) else ""
            key_input = st.text_input(
                f"API Key #{i+1}", 
                value=val,
                type="password",
                placeholder=f"Paste API Key ke-{i+1} di sini...",
                key=f"api_key_input_{i}"
            )
            if key_input.strip():
                new_api_keys.append(key_input.strip())
    
    if st.button("üíæ Simpan API Keys (Sesi Ini)"):
        if new_api_keys:
            st.session_state.saved_api_keys = new_api_keys
            st.success(f"‚úÖ Tersimpan {len(new_api_keys)} API Keys untuk sesi ini!")
            st.info("üí° Keys akan aktif selama browser tidak di-refresh. Untuk save permanen, edit file `.streamlit/secrets.toml` secara manual.")
        else:
            st.warning("Minimal isi 1 API Key dong bos!")
            
    st.divider()

st.sidebar.header("Pilih Jenis Produk")
product_type = st.sidebar.radio(
    "Kategori:",
    ("Ebook / Produk Digital", "Produk Fisik / Barang")
)

# --- API KEY SETUP ---
# Use the keys collected from the inputs (if any) or load from secrets or session state
if 'saved_api_keys' not in st.session_state:
    st.session_state.saved_api_keys = []

# Priority: new_api_keys from current input > session state > secrets file
if new_api_keys:
    api_keys = new_api_keys
    st.session_state.saved_api_keys = new_api_keys  # Save to session for persistence during session
elif st.session_state.saved_api_keys:
    api_keys = st.session_state.saved_api_keys
elif "GOOGLE_API_KEY" in st.secrets:
    raw_keys = st.secrets["GOOGLE_API_KEY"]
    api_keys = [k.strip() for k in raw_keys.split('\n') if k.strip()]
    st.session_state.saved_api_keys = api_keys
else:
    api_keys = []

# --- HELPER: ROTATION GENERATOR ---
def generate_content_with_rotation(prompt, keys):
    last_error = None
    for i, key in enumerate(keys):
        try:
            genai.configure(api_key=key)
            # Try Flash model first (2.0), fallback to latest alias
            try:
                model = genai.GenerativeModel('gemini-2.0-flash')
                response = model.generate_content(prompt)
                return response
            except Exception:
                model = genai.GenerativeModel('gemini-flash-latest')
                response = model.generate_content(prompt)
                return response
        except Exception as e:
            last_error = e
            print(f"Key {i+1} failed: {e}")
            continue # Try next key
    
    # If all failed
    raise last_error

if api_keys:
    # Configure with first key just for init (though rotation handles it)
    genai.configure(api_key=api_keys[0])

# --- MAIN CONTENT ---
st.title("üöÄ Landing Page Generator AI")
st.markdown("Buat landing page profesional dalam hitungan detik menggunakan Google Gemini.")

# --- SESSION STATE INIT ---
if "target_audience" not in st.session_state: st.session_state.target_audience = ""
if "cta_text" not in st.session_state: st.session_state.cta_text = ""
if "product_desc" not in st.session_state: st.session_state.product_desc = ""
if "generated_html" not in st.session_state: st.session_state.generated_html = None
if "copy_sections" not in st.session_state: st.session_state.copy_sections = {}

# --- INPUT SECTION ---
product_name = st.text_input("Nama Produk (Wajib)", placeholder="Contoh: Ebook Jago Python / Sepatu Anti Air")
product_image = st.text_input("Link Gambar Utama / Hero (URL - Opsional)", placeholder="https://example.com/gambar-utama.jpg")

with st.expander("üñºÔ∏è Tambah Gambar Lain (Untuk Section Features/Gallery)"):
    additional_images_str = st.text_area("Masukkan URL Gambar Tambahan (Satu per baris)", placeholder="https://example.com/img1.jpg\nhttps://example.com/img2.jpg")

# Ebook Upload
uploaded_ebook = st.file_uploader("üìÇ Upload Ebook/Materi Produk (PDF, DOCX, TXT) - Opsional", type=["pdf", "docx", "txt"], help="AI akan membaca isi file ini untuk membuat konten landing page yang lebih akurat dan 'berisi'.")

if st.button("‚ú® Isi Otomatis (Magic Fill)"):
    if not product_name:
        st.error("Isi Nama Produk dulu dong!")
    elif not api_keys:
        st.error("API Key belum ada! Cek sidebar.")
    else:
        with st.spinner("Sedang menerawang ide marketing..."):
            try:
                prompt = f"""
                Berikan ide marketing untuk produk: "{product_name}".
                Outputkan HANYA JSON dengan format:
                {{
                    "target_audience": "Target audience spesifik",
                    "cta_text": "Kata-kata tombol CTA yang menarik (pendek)",
                    "product_desc": "Deskripsi produk yang persuasif (2-3 kalimat)"
                }}
                """
                
                response = generate_content_with_rotation(prompt, api_keys)
                
                text = response.text.replace("```json", "").replace("```", "")
                data = json.loads(text)
                
                # Handle case where AI returns a list instead of dict
                if isinstance(data, list):
                    data = data[0]
                
                st.session_state.target_audience = data.get("target_audience", "")
                st.session_state.cta_text = data.get("cta_text", "")
                st.session_state.product_desc = data.get("product_desc", "")
                st.success("Berhasil diisi! Silakan review di bawah.")
                st.rerun()
            except Exception as e:
                st.error(f"Gagal generate: {e}")

with st.form("input_form"):
    col1, col2 = st.columns(2)
    
    with col1:
        target_audience = st.text_input("Target Audience", key="target_audience", placeholder="Kosongkan jika ingin AI yang menentukan")
    
    with col2:
        cta_text = st.text_input("Teks Tombol / CTA", key="cta_text", placeholder="Kosongkan jika ingin AI yang menentukan")
        
    # Tone of Voice Selector
    tone = st.selectbox(
        "Gaya Bahasa Copywriting",
        ("Profesional & Berwibawa", "Santai & Akrab (Bahasa Gaul)", "Persuasif & Hard Selling", "Emosional & Menyentuh Hati", "Lucu & Humoris", "Curhat & Personal (Deep Talk)"),
        index=5
    )
    
    # --- COMPETITOR URL HISTORY ---
    history_file = "competitor_history.json"
    try:
        with open(history_file, "r") as f:
            url_history = json.load(f)
    except (FileNotFoundError, json.JSONDecodeError):
        url_history = []

    # Dropdown for history
    history_options = ["‚ûï Input URL Baru"] + url_history
    selected_history = st.selectbox("Pilih Link Kompetitor (Riwayat)", history_options)
    
    if selected_history == "‚ûï Input URL Baru":
        competitor_url = st.text_input("Link Kompetitor Baru (Opsional)", placeholder="Masukkan URL landing page kompetitor...")
    else:
        competitor_url = st.text_input("Link Kompetitor (Opsional - Fitur ATM)", placeholder="Masukkan URL landing page kompetitor untuk ditiru polanya...")
        
    # Conversion Boosters Toggle
    use_boosters = st.checkbox("üî• Aktifkan Fitur 'Booster Penjualan' (Sticky CTA, Timer, FAQ, Garansi)", value=True)
    
    product_desc = st.text_area("Deskripsi & Manfaat Utama", key="product_desc", height=150, placeholder="Kosongkan jika ingin AI yang mengarang deskripsi berdasarkan Nama Produk...")
    

    
    # Copy Helper
    with st.expander("üìã Copy Teks (Target, CTA, Deskripsi)"):
        st.caption("Klik ikon 'Copy' di pojok kanan atas setiap blok untuk menyalin.")
        st.text("Target Audience:")
        st.code(st.session_state.target_audience, language=None)
        st.text("CTA:")
        st.code(st.session_state.cta_text, language=None)
        st.text("Deskripsi:")
        st.code(st.session_state.product_desc, language=None)
    
    submitted = st.form_submit_button("‚ú® Generate Landing Page")

# --- AI LOGIC ---
if submitted:
    if not product_name:
        st.error("Mohon isi Nama Produk!")
    else:
        # Save URL to history if new
        if competitor_url and competitor_url not in url_history:
            url_history.append(competitor_url)
            with open(history_file, "w") as f:
                json.dump(url_history, f)
        if not api_keys:
            st.error("‚ö†Ô∏è API Key belum dimasukkan! Silakan masukkan di Sidebar sebelah kiri atau setting di secrets.toml")
            st.stop()
            
        # Loading State
        with st.spinner("Sedang meracik copywriting & kodingan... (Mungkin butuh 10-20 detik)"):
            try:
                # --- PROMPT ENGINEERING ---
                # Handle optional fields
                desc_prompt = product_desc if product_desc else "TIDAK ADA. Karanglah deskripsi yang sangat menarik, persuasif, dan menjual berdasarkan Nama Produk. Buat seolah-olah ini produk best-seller."
                target_prompt = target_audience if target_audience else "TIDAK ADA. Analisa dan tentukan target audience yang paling relevan dan potensial untuk produk ini."
                cta_prompt = cta_text if cta_text else "TIDAK ADA. Buat CTA yang mendesak dan mengundang klik (misal: Beli Sekarang, Ambil Diskon 50%, dll)."
                
                competitor_data = ""
                if competitor_url:
                    scraped_text = scrape_content(competitor_url)
                    competitor_data = f"""
                    DATA KOMPETITOR (ATM - AMATI TIRU MODIFIKASI):
                    Berikut adalah konten dari landing page kompetitor:
                    ---
                    {scraped_text}
                    ---
                    TUGAS ATM (FOKUS COPYWRITING SAJA):
                    1. **AMBIL KONSEP COPYWRITINGNYA**: Pelajari flow, hook, angle, dan cara mereka menjual (Storytelling? Hard selling? Fear mongering?).
                    2. **TIRU STRUKTUR PERSUASINYA**: Jika mereka mulai dengan masalah -> solusi -> testimoni, ikuti alur tersebut.
                    3. **JANGAN TIRU DESAINNYA**: Buat desain yang JAUH LEBIH BAGUS, LEBIH PREMIUM, dan LEBIH MODERN dari kompetitor. Jangan terpaku pada tampilan visual mereka yang mungkin jadul.
                    4. **MODIFIKASI ISI**: Tulis ulang dengan gaya bahasa kita yang lebih "nendang".
                    """

                ebook_content = ""
                if uploaded_ebook:
                    file_text = read_file_content(uploaded_ebook)
                    # Limit content to prevent token overflow (approx 10k chars)
                    ebook_content = f"""
                    SUMBER MATERI / ISI EBOOK (WAJIB DIGUNAKAN SEBAGAI REFERENSI UTAMA):
                    Berikut adalah ringkasan/isi dari produk yang dijual:
                    ---
                    {file_text[:15000]} 
                    ---
                    INSTRUKSI KHUSUS:
                    1. Gunakan materi di atas untuk menulis Body Copy, Benefit, dan Storytelling yang SANGAT RELEVAN.
                    2. Jangan mengarang bebas jika info sudah ada di materi ini.
                    3. Ambil "Emas" (poin penting) dari materi ini untuk dijadikan Hook.
                    """

                booster_instruction = ""
                if use_boosters:
                    booster_instruction = """
                    FITUR BOOSTER PENJUALAN (WAJIB ADA):
                    1. **STICKY CTA (Mobile Only)**: Buat tombol CTA yang melayang di bawah layar (fixed bottom) khusus tampilan mobile. Gunakan class `fixed bottom-0 left-0 w-full p-4 bg-white shadow-lg md:hidden z-50`.
                    2. **FAQ SECTION**: Buat section FAQ (Tanya Jawab) yang menjawab 3-5 keraguan utama pembeli (Objection Handling). Gunakan tag <details> dan <summary> untuk accordion.
                    3. **TRUST BADGES**: Tambahkan elemen visual "Garansi 30 Hari Uang Kembali", "Pembayaran Aman", dll di bawah tombol CTA.
                    """

                # Prepare Image Instructions
                image_instruction = ""
                
                # URL Images Logic
                if product_image:
                    image_instruction += f"\nIMAGE URL UTAMA (HERO): {product_image}\n"
                if additional_images_str:
                    image_instruction += f"\nIMAGE URL TAMBAHAN: {additional_images_str}\n"
                
                if not product_image and not additional_images_str:
                    image_instruction += "\nTIDAK ADA GAMBAR. Gunakan Placeholder dari unsplash/placehold.co.\n"

                image_instruction += f"\nGAYA BAHASA: {tone} (Wajib ikuti tone ini di seluruh teks!)\n"

                base_prompt = f"""
                Bertindaklah sebagai Expert Web Developer & UI/UX Designer kelas dunia yang biasa menangani klien "High-Ticket".
                Tugasmu adalah membuat SATU FILE HTML LENGKAP (Single File) untuk Landing Page produk dengan standar desain PREMIUM.
                
                DATA PRODUK:
                - Nama: {product_name}

                
                {competitor_data}
                
                {ebook_content}
                
                INSTRUKSI DESAIN (PENTING):
                1. **PENGGUNAAN GAMBAR (WAJIB)**:
                   {image_instruction}
                   - Buat layout `zig-zag` (Gambar Kiri - Teks Kanan, lalu sebaliknya) agar dinamis.
                1. **VIBE**: PROFESIONAL, MENARIK, dan "SOFT". Jangan terlalu polos (boring), tapi jangan norak. Harus terlihat "Eye-Catching" tapi tetap elegan.
                2. **COLOR PALETTE**: Gunakan warna-warna **SOFT PASTEL & GRADIENT**.
                   - Background utama jangan hanya putih polos. Gunakan `bg-slate-50`, `bg-blue-50`, atau gradient halus `bg-gradient-to-br from-indigo-50 to-white`.
                   - Gunakan warna Primary yang lembut tapi tegas (misal: Soft Blue, Sage Green, atau Coral).
                3. **LAYOUT & SECTIONS**:
                   - **Alternating Backgrounds**: Pastikan setiap section punya warna background yang selang-seling (Misal: Hero (Gradient) -> Features (White) -> Testimoni (Soft Grey) -> CTA (Accent Color)).
                   - Gunakan **Card Design** (Kotak putih dengan shadow halus) untuk menonjolkan konten di atas background berwarna.
                   - **NO HERO CTA**: JANGAN ada tombol CTA di Hero Section (Header). CTA baru boleh muncul setelah penjelasan produk/masalah.
                4. **TYPOGRAPHY & READABILITY (SUPER CRITICAL)**:
                   - **FONT**: Gunakan 'Plus Jakarta Sans' atau 'Outfit' (Google Fonts).
                   - **NO SINGLE QUOTES (HARGA MATI)**: DILARANG KERAS menggunakan tanda petik satu (') untuk penekanan kata atau bahasa gaul!
                     - SALAH: 'keliatan', 'aturan main', 'jualan', 'pemain cadangan'.
                     - BENAR: Tulis biasa saja atau gunakan **Bold** untuk kata sangat penting.
                   - **NO MARKDOWN SYNTAX (HARGA MATI)**: DILARANG menggunakan markdown syntax (asterisk) di dalam HTML!
                     - SALAH: *italic*, **bold**, ***bold italic***
                     - BENAR: <em>italic</em>, <strong>bold</strong>, atau tulis biasa saja.
                     - Ini HTML, bukan Markdown! Jangan pernah pakai tanda asterisk (*) untuk formatting.
                   - **NO COLOR EMPHASIS**: DILARANG menggunakan warna berbeda untuk penekanan teks (text-indigo-600, text-blue-600, dll).
                     - Semua teks body harus warna uniform: `text-slate-700` atau `text-gray-700`.
                     - Jika ingin penekanan, gunakan `<strong>` atau `<b>` (Bold) saja.
                   - **PARAGRAPH STRUCTURE (ULTRA STRICT - NO EXCEPTIONS)**:
                     - ATURAN EMAS: Setiap `<p>` tag HANYA boleh berisi MAKSIMAL 2 KALIMAT.
                     - CARA KERJA:
                       1. Tulis kalimat pertama. Titik.
                       2. Tulis kalimat kedua. Titik.
                       3. LANGSUNG tutup `</p>` dan buka `<p class="mb-3">` baru untuk kalimat ke-3.
                     - CONTOH BENAR (Copy persis format ini):
                       ```html
                       <p class="mb-3 text-slate-700">Gue paham banget rasanya. Kerja keras bagus, tapi yang dipromosiin temen yang lebih jago ngobrol.</p>
                       <p class="mb-3 text-slate-700">Lo bukan iri, cuma kesel. Karena lo tau, lo lebih capable.</p>
                       <p class="mb-3 text-slate-700">Di kantor, kerja keras emang dihargai sampai titik tertentu. Setelah itu yang dinilai adalah siapa yang bisa bikin bos ngerasa nyaman.</p>
                       ```
                     - CONTOH SALAH (JANGAN LAKUKAN INI):
                       ```html
                       <p class="mb-3 text-slate-700">Gue paham banget rasanya. Kerja keras bagus, tapi yang dipromosiin temen yang lebih jago ngobrol. Lo bukan iri, cuma kesel. Karena lo tau, lo lebih capable. Di kantor, kerja keras emang dihargai sampai titik tertentu.</p>
                       ```
                     - ENFORCEMENT: Hitung titik (.) di setiap paragraf. Jika lebih dari 2 titik, itu SALAH TOTAL!
                   - **LINE HEIGHT**: Gunakan `leading-normal` atau `leading-snug` (Jangan terlalu lega).
                   - **PARAGRAPH SPACING**: Gunakan `mb-3` (Jarak antar paragraf cukup dekat).
                   - **MOBILE PADDING**: Container teks WAJIB `px-4` di mobile (JANGAN px-6 atau px-8, terlalu lebar!).
                   - **TEXT COLOR**: Gunakan `text-slate-700` atau `text-gray-800`.
                   - **MAX WIDTH**: Batasi lebar teks paragraf dengan `max-w-2xl mx-auto`.
                5. **UI TRENDS (AESTHETIC & CLEAN)**:
                   - **PREMIUM CARDS**: Card putih dengan `rounded-2xl`, `p-6` (padding cukup), dan `shadow-[0_8px_30px_rgb(0,0,0,0.04)]`.
                   - **VISUAL BREAKERS**: Gunakan Divider halus atau Icon kecil antar section.
                   - **BUTTONS**: Gradient halus dengan shadow.
                   - **SECTIONING**: `py-6` atau `py-8` (Jarak antar section TIDAK BOLEH terlalu panjang).
                6. **MOBILE RESPONSIVENESS (HARGA MATI)**:
                   - **CONTAINER PADDING**: Gunakan class `px-6` atau `px-8` pada container utama (`<div class="container mx-auto px-6">`).
                   - **JANGAN MEPET**: Teks tidak boleh menyentuh pinggir layar HP. Harus ada jarak minimal 24px (1.5rem).
                   - **FONT SIZE MOBILE**: Gunakan `text-[16px]` atau `text-[18px]` agar terbaca jelas. Jangan kekecilan.
                   - **STACKING**: Pada mobile, kolom harus `flex-col` (menumpuk ke bawah). Jangan maksa `flex-row`.
                7. **TRUST ELEMENTS**: Tambahkan section "Featured In" atau "Trusted By" dengan logo placeholder grayscale.
                
                {booster_instruction}
                
                TEKNIS:
                - Gunakan Tailwind CSS via CDN (wajib).
                - Pastikan Mobile Responsive 100%.
                - Jangan gunakan CSS eksternal atau JS eksternal selain Tailwind CDN.
                - Pastikan tag <html>, <head>, dan <body> lengkap.
                - JIKA ADA IMAGE URL: Wajib gunakan `{product_image}` sebagai gambar utama/hero image. Jangan gunakan placeholder untuk gambar utama jika URL ini ada.
                """

                if product_type == "Ebook / Produk Digital":
                    scenario_prompt = """
                    SKENARIO: EBOOK / DIGITAL PRODUCT (Storytelling Mode)
                    Struktur Halaman:
                    1. **Headline Provokatif**: Fokus pada pain point/frustasi {target_audience}. Gunakan font besar & bold.
                    2. **Story Section**: 2-3 paragraf pendek. Ceritakan masalah yang relate dengan user. Gunakan bahasa santai ("Lu/Gue" atau "Anda" yang akrab).
                    3. **Solution**: Perkenalkan {product_name} sebagai solusi akhir.
                    4. **What You Get**: List bullet points materi/isi produk.
                    5. **Kenapa Ini Penting**: Section yang menjelaskan WHY user harus peduli/action sekarang. Fokus pada konsekuensi TIDAK belajar ini (kehilangan peluang, tetap stuck, dll). 2-3 paragraf pendek yang memotivasi.
                    6. **Bonus Section**: Tambahkan 2-3 bonus fiktif yang relevan (misal: Cheatsheet, Video Tutorial) untuk menaikkan value.
                    7. **Pricing & Guarantee**: Tampilkan harga coret (diskon) dan Garansi Uang Kembali 30 Hari.
                    8. **Sticky CTA**: Tombol beli yang sangat menonjol warnanya.
                    """
                else: # Produk Fisik
                    scenario_prompt = """
                    SKENARIO: PRODUK FISIK (Visual & Urgency Mode)
                    Struktur Halaman:
                    1. **Hero Section**: Background bersih, Placeholder gambar produk besar di tengah/kanan. Headline kuat & singkat.
                    2. **Agitation**: Sub-headline yang menekan masalah (misal: "Sering merasa minder karena...?").
                    3. **Product Solution**: Penjelasan singkat cara pakai & solusi praktis.
                    4. **Benefit Grid**: Layout Grid 2x2 atau 4 kolom. Ikon (bisa pakai emoji atau SVG inline) + Poin keunggulan.
                    5. **Social Proof**: Placeholder untuk 3 testimoni user (Foto bulat + Nama + Teks pendek).
                    6. **Scarcity Offer**: "Promo Terbatas", "Beli 2 Gratis 1", atau Countdown Timer (tampilan visual saja). Harga coret besar.
                    7. **Simple Form**: Form statis (hanya tampilan) untuk Nama & WhatsApp sebelum tombol CTA.
                    """

                json_instruction = """
                INSTRUKSI OUTPUT (WAJIB JSON):
                Jangan hanya berikan HTML. Outputkan data dalam format JSON valid sebagai berikut:
                {
                    "copywriting": {
                        "headline": "Headline yang nendang...",
                        "subheadline": "Subheadline yang menjelaskan benefit...",
                        "body_copy": "Paragraf pembuka/storytelling...",
                        "benefits": ["Benefit 1", "Benefit 2", "Benefit 3", ...],
                        "cta": "Teks tombol CTA",
                        "guarantee": "Teks garansi..."
                    },
                    "html_code": "<!DOCTYPE html>..."
                }
                Pastikan "html_code" berisi kode HTML lengkap (Single File) dengan CSS Tailwind yang sudah di-embed.
                """

                final_prompt = base_prompt + "\n" + scenario_prompt + "\n" + json_instruction

                # Generate with Rotation
                response = generate_content_with_rotation(final_prompt, api_keys)
                
                # Parse JSON Response
                text_response = response.text.replace("```json", "").replace("```", "")
                try:
                    data = json.loads(text_response)
                    # Handle if AI returns list
                    if isinstance(data, list): data = data[0]
                    
                    generated_html = data.get("html_code", "")
                    copy_sections = data.get("copywriting", {})
                except json.JSONDecodeError:
                    # Fallback if JSON fails (rare but possible)
                    generated_html = text_response
                    copy_sections = {}
                    st.error("Gagal memisahkan copywriting, tapi HTML mungkin masih aman.")

                # Save to session state
                st.session_state.generated_html = generated_html
                st.session_state.copy_sections = copy_sections

                # Success message
                st.success("Landing Page Berhasil Dibuat! üéâ")
            except Exception as e:
                error_msg = str(e)
                if "403" in error_msg and "leaked" in error_msg:
                    st.error("‚õî **API Key Bermasalah!** Google mendeteksi API Key Anda bocor/tidak aman. Silakan buat API Key baru di Google AI Studio dan masukkan di sidebar.")
                elif "429" in error_msg:
                    st.error("‚è≥ **Kuota Habis!** API Key Anda terkena limit (Rate Limit). Coba tunggu beberapa saat atau tambahkan API Key cadangan di sidebar.")
                else:
                    st.error(f"Gagal generate: {e}")
                st.info("üí° **Tip**: Pastikan koneksi internet lancar dan API Key valid.")

                
            except Exception as e:
                error_msg = str(e)
                if "403" in error_msg and "leaked" in error_msg:
                    st.error("‚õî **API Key Bermasalahantygravity/landing-page-app/.venv/bin/python -m pip install -r requirements.txt* Google mendeteksi API Key Anda bocor/tidak aman. Silakan buat API Key baru di Google AI Studio dan masukkan di sidebar.")
                elif "429" in error_msg:
                    st.error("‚è≥ **Kuota Habisantygravity/landing-page-app/.venv/bin/python -m pip install -r requirements.txt* API Key Anda terkena limit (Rate Limit). Coba tunggu beberapa saat atau tambahkan API Key cadangan di sidebar.")
                else:
                    st.error(f"Gagal generate: {e}")
                st.info("üí° **Tip**: Pastikan koneksi internet lancar dan API Key valid.")

# --- DISPLAY PREVIEW (FROM SESSION STATE) ---
if st.session_state.generated_html:
    # Create tabs for preview and code
    tab1, tab2, tab3 = st.tabs(["üñ•Ô∏è Desktop Preview", "üì± Mobile Preview", "üíª Source Code"])
    
    # Display HTML
    with tab1:
        st.caption("Preview Desktop (Full Width)")
        components.html(st.session_state.generated_html, height=800, scrolling=True)

    with tab2:
        st.caption("Preview Mobile (iPhone SE/12/13 style - 375px)")
        col_m1, col_m2, col_m3 = st.columns([1, 2, 1])
        with col_m2:
            # Simulate mobile frame
            st.markdown(
                """
                <style>
                .mobile-frame {
                    border: 8px solid #333;
                    border-radius: 20px;
                    overflow: hidden;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                }
                </style>
                <div class="mobile-frame">
                """, unsafe_allow_html=True
            )
            components.html(st.session_state.generated_html, height=700, width=375, scrolling=True)
            st.markdown("</div>", unsafe_allow_html=True)
    
    with tab3:
        st.code(st.session_state.generated_html, language="html")

    # Download Button
    st.download_button(
        label="‚¨áÔ∏è Download HTML File",
        data=st.session_state.generated_html,
        file_name="landing_page.html",
        mime="text/html"
    )
    
    # Copywriting Sections
    if st.session_state.copy_sections:
        st.divider()
        st.subheader("üìù Draft Copywriting (Siap Copy)")
        st.info("Jika Anda hanya butuh teksnya saja untuk dipasang di platform lain (WordPress, Elementor, dll).")
        
        with st.expander("Lihat Draft Copywriting", expanded=True):
            st.text("Headline:")
            st.code(st.session_state.copy_sections.get("headline", ""), language=None)
            
            st.text("Subheadline:")
            st.code(st.session_state.copy_sections.get("subheadline", ""), language=None)
            
            st.text("Body Copy / Story:")
            st.code(st.session_state.copy_sections.get("body_copy", ""), language=None)
            
            st.text("Poin-Poin Benefit:")
            benefits_text = "\n".join([f"- {b}" for b in st.session_state.copy_sections.get("benefits", [])])
            st.code(benefits_text, language=None)
            
            st.text("CTA Copy:")
            st.code(st.session_state.copy_sections.get("cta", ""), language=None)
            
            st.text("Garansi:")
            st.code(st.session_state.copy_sections.get("guarantee", ""), language=None)

```
